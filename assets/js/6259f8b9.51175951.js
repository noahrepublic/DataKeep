"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[616],{3018:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>c,default:()=>p,frontMatter:()=>s,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"DevProducts","title":"Developer Products","description":"The following example shows how you would handle developer product purchases:","source":"@site/docs/DevProducts.md","sourceDirName":".","slug":"/DevProducts","permalink":"/DataKeep/docs/DevProducts","draft":false,"unlisted":false,"editUrl":"https://github.com/noahrepublic/DataKeep/edit/main/docs/DevProducts.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"defaultSidebar","previous":{"title":"WriteLib","permalink":"/DataKeep/docs/WriteLib"},"next":{"title":"DataKeep vs ProfileService","permalink":"/DataKeep/docs/Versus"}}');var r=n(4848),o=n(8453);const s={sidebar_position:5},c="Developer Products",l={},d=[];function i(e){const t={code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"developer-products",children:"Developer Products"})}),"\n",(0,r.jsx)(t.p,{children:"The following example shows how you would handle developer product purchases:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-lua",metastring:'title="DataTemplate.luau"',children:"local dataTemplate = {\n\tPurchaseHistory = {},\n\n\tCoins = 0,\n}\n\nexport type template = typeof(dataTemplate)\n\nreturn table.freeze(dataTemplate)\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-lua",metastring:'title="DevProducts.luau"',children:"local DataKeep = require(path_to_datakeep)\nlocal DataTemplate = require(path_to_datatemplate)\n\nlocal devProducts = {\n    [product_id_here] = function(player: Player, keep: DataKeep.Keep<DataTemplate.template>)\n        keep.Data.Coins += 100\n\n\t\tprint(`{player.Name} purchased some coins!`)\n    end,\n}\n\nreturn devProducts\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-lua",metastring:'title="SetProcessReceipt.luau"',children:'local MarketplaceService = game:GetService("MarketplaceService")\nlocal Players = game:GetService("Players")\n\nlocal DataKeep = require(path_to_datakeep)\nlocal DataTemplate = require(path_to_datatemplate)\nlocal DevProducts = require(path_to_devproducts)\n\nlocal purchaseHistoryLimit = 50\n\nlocal function setProcessReceipt(store: DataKeep.Store<DataTemplate.template>, keyPrefix: string)\n\tlocal function processReceipt(receiptInfo): Enum.ProductPurchaseDecision\n\t\tlocal player = Players:GetPlayerByUserId(receiptInfo.PlayerId)\n\n\t\tif not player then\n\t\t\treturn Enum.ProductPurchaseDecision.NotProcessedYet\n\t\tend\n\n\t\tlocal isLoaded, keep = store:LoadKeep(keyPrefix .. player.UserId):await()\n\n\t\tif not isLoaded then\n\t\t\treturn Enum.ProductPurchaseDecision.NotProcessedYet\n\t\tend\n\n\t\tif not keep then\n\t\t\treturn Enum.ProductPurchaseDecision.NotProcessedYet\n\t\tend\n\n\t\tif not keep:IsActive() then\n\t\t\treturn Enum.ProductPurchaseDecision.NotProcessedYet\n\t\tend\n\n\t\tif not keep.Data.PurchaseHistory then\n\t\t\tkeep.Data.PurchaseHistory = {}\n\t\tend\n\n\t\tif table.find(keep.Data.PurchaseHistory, receiptInfo.PurchaseId) then\n\t\t\t-- the purchase has been added to the player\'s data, but it might not have saved yet\n\t\t\tlocal success = keep:Save():await()\n\n\t\t\tif success then\n\t\t\t\treturn Enum.ProductPurchaseDecision.PurchaseGranted\n\t\t\telse\n\t\t\t\treturn Enum.ProductPurchaseDecision.NotProcessedYet\n\t\t\tend\n\t\tend\n\n\t\t-- remove purchaseIds which are beyond the limit\n\t\twhile #keep.Data.PurchaseHistory >= purchaseHistoryLimit do\n\t\t\ttable.remove(keep.Data.PurchaseHistory, 1)\n\t\tend\n\n\t\tlocal grantProductSuccess = pcall(DevProducts[receiptInfo.ProductId], player, keep)\n\n\t\tif not grantProductSuccess then\n\t\t\treturn Enum.ProductPurchaseDecision.NotProcessedYet\n\t\tend\n\n\t\ttable.insert(keep.Data.PurchaseHistory, receiptInfo.PurchaseId)\n\n\t\tlocal saveSuccess = keep:Save():await()\n\n\t\tif not saveSuccess then\n\t\t\treturn Enum.ProductPurchaseDecision.NotProcessedYet\n\t\tend\n\n\t\treturn Enum.ProductPurchaseDecision.PurchaseGranted\n\tend\n\n\tMarketplaceService.ProcessReceipt = processReceipt\nend\n\nreturn setProcessReceipt\n'})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-lua",metastring:'title="Main.luau"',children:'local Players = game:GetService("Players")\n\nlocal DataKeep = require(path_to_datakeep)\nlocal DataTemplate = require(path_to_datatemplate)\nlocal SetProcessReceipt = require(path_to_setprocessreceipt)\n\nlocal keyPrefix = "Player_"\n\nlocal loadedKeeps = {}\n\nlocal store = DataKeep.GetStore("PlayerData", DataTemplate):expect()\n\nlocal function onPlayerAdded(player: Player)\n\tstore:LoadKeep(keyPrefix .. player.UserId):andThen(function(keep)\n\t\tkeep:Reconcile()\n\t\tkeep:AddUserId(player.UserId) -- help with GDPR requests\n\n\t\tkeep.Released:Connect(function()\n\t\t\tprint(`{player.Name}\'s Keep has been released!`)\n\n\t\t\tloadedKeeps[player] = nil\n\t\t\tplayer:Kick("Session released!")\n\t\tend)\n\n\t\tkeep.ReleaseFailed:Connect(function()\n\t\t\tprint(`Failed to release {player.Name}\'s Keep!`)\n\n\t\t\tloadedKeeps[player] = nil\n\t\t\tplayer:Kick("Failed to release session!")\n\t\tend)\n\n\t\tif not player:IsDescendantOf(Players) then\n\t\t\tkeep:Release():catch(function() end)\n\t\t\treturn\n\t\tend\n\n\t\tloadedKeeps[player] = keep\n\n\t\tprint(`Loaded {player.Name}\'s Keep!`)\n\tend):catch(function()\n\t\tplayer:Kick("Data failed to load")\n\tend)\nend\n\n-- SetProcessReceipt() must be called before the onPlayerAdded(),\n-- otherwise the player\'s existing receipts won\'t be processed.\nSetProcessReceipt(store, keyPrefix)\n\n-- loop through already connected players in case they joined before DataKeep loaded\nfor _, player in Players:GetPlayers() do\n\ttask.spawn(onPlayerAdded, player)\nend\n\nPlayers.PlayerAdded:Connect(onPlayerAdded)\n\nPlayers.PlayerRemoving:Connect(function(player)\n\tlocal keep = loadedKeeps[player]\n\n\tif not keep then\n\t\treturn\n\tend\n\n\tkeep:Release():catch(function() end)\nend)\n'})})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(i,{...e})}):i(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>c});var a=n(6540);const r={},o=a.createContext(r);function s(e){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),a.createElement(o.Provider,{value:t},e.children)}}}]);